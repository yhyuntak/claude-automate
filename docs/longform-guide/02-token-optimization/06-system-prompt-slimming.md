# System Prompt Slimming: 고급 토큰 최적화 기법

> ⚠️ **ADVANCED TECHNIQUE WARNING** / **고급 기법 주의**
>
> 이 섹션은 매우 고급 주제입니다. Claude의 시스템 프롬프트를 수정하는 것은:
>
> - **실험적 기법**입니다
> - 예상치 못한 부작용이 발생할 수 있습니다
> - 철저한 테스트가 필수입니다
> - **프로덕션 환경에 신중하게 적용**해야 합니다
>
> 이 기법은 **고급 사용자**만 권장됩니다. 대부분의 경우, 다른 최적화 기법(prompt 축약, batch processing 등)으로 충분합니다.

---

## 개요 (Overview)

**System Prompt Slimming**은 Claude의 시스템 프롬프트에서 불필요한 부분을 제거하여 토큰 사용량을 극적으로 줄이는 기법입니다.

### 문제 상황

Claude Code를 사용할 때, Claude 내부 시스템 프롬프트는:

| 항목 | 수치 |
|------|------|
| **Claude Code 시스템 프롬프트 크기** | ~18,000 토큰 |
| **200k 컨텍스트 윈도우에서의 비중** | ~9% |
| **패치 적용 후 크기** | ~10,000 토큰 |
| **토큰 절감량** | 약 7,300 토큰 |
| **절감 율** | 41% 감소 |

즉, **매 요청마다 18,000 토큰을 "낭비"** 하고 있을 수 있습니다.

### 핵심 아이디어

Claude의 시스템 프롬프트에는:

```
✗ 불필요한 설명문
✗ 과도한 예제
✗ 사용하지 않는 기능 설명
✗ 여러 언어의 중복 설명
```

등이 포함되어 있을 수 있습니다. 이를 제거하면 **동일한 기능을 유지하면서도 토큰을 절감**할 수 있습니다.

---

## 작동 원리 (How It Works)

### 시스템 프롬프트의 구조

Claude의 시스템 프롬프트는 대략 다음 구조입니다:

```
1. Claude의 기본 가치관과 행동 원칙
2. Tool 사용 가능한 기능 설명 (매우 상세)
3. Claude Code 관련 지시사항
4. 각 Tool의 상세한 사용 설명서
5. 보안 및 제약사항
6. 특수 사례 처리 방법
```

### 최적화 포인트

| 섹션 | 최적화 가능성 | 설명 |
|------|------------|------|
| 기본 가치관 | 낮음 | 절대 제거하면 안 됨 |
| Tool 설명 | **높음** | 상세한 설명을 축약 가능 |
| 예제 | **높음** | 일부 예제 제거 가능 |
| 중복 설명 | **높음** | 언어별 중복 제거 |
| 엣지 케이스 | 중간 | 일부 엣지 케이스는 제거 가능 |
| 보안 지시사항 | 매우 낮음 | 절대 건드리면 안 됨 |

---

## YK's System Prompt Patches

효과적인 패치를 만들기 위해, 다음 참고 자료를 활용할 수 있습니다:

**GitHub Repository**: [system-prompt-patches](https://github.com/yk-dang/system-prompt-patches)

이 저장소는:

- 검증된 시스템 프롬프트 패치 제공
- Tool별 최적화 기법 설명
- 안전한 제거 체크리스트
- 성능 영향 분석 데이터

제공하고 있습니다.

### 패치의 주요 내용

```markdown
# 안전한 제거 항목
- 도움말 텍스트의 불필요한 설명
- 중복된 사용 예제
- 거의 사용하지 않는 고급 옵션 설명

# 절대 제거하면 안 되는 항목
- Tool의 실제 작동 방식
- 보안 및 제약사항
- 에러 처리 지시사항
- 입력/출력 형식 사양
```

---

## 구현 전략 (Implementation Strategy)

### 1단계: 기준선 설정

```bash
# 현재 시스템 프롬프트 크기 측정
# (이는 API를 통해서만 가능하며, 직접 접근은 불가능함)

# 대신 다음으로 테스트:
# - 현재 응답 시간 측정
# - 토큰 사용량 추적
# - 오류율 기록
```

### 2단계: 패치 제작

패치를 안전하게 만들려면:

```markdown
1. 한 번에 한 섹션만 수정
2. 각 수정 후 철저히 테스트
3. 기능 손실 여부 확인
4. 성능 변화 측정
5. 롤백 계획 준비
```

### 3단계: 테스트 전략

```python
# 테스트 케이스 예시
test_cases = [
    # 기본 기능
    ("Can you write a Python function?", "must_work"),
    ("Analyze this code for bugs", "must_work"),

    # Tool 사용
    ("Read file at /path/to/file", "must_work"),
    ("Search for pattern in codebase", "must_work"),

    # 엣지 케이스
    ("Handle very large files", "verify_graceful_failure"),
    ("Concurrent operations", "verify_correctness"),
]

# 각 테스트 전후 비교
# - 응답의 정확도
# - 오류 처리 능력
# - 토큰 사용량
```

### 4단계: 성능 측정

최적화 효과를 측정하려면:

```
메트릭 | 측정 방법
------|----------
토큰 절감 | 요청 전후 비교
응답 속도 | 평균 응답 시간 (ms)
정확도 | 테스트 케이스 통과율
안정성 | 오류율, 예외 발생 빈도
```

---

## 저자의 개인 선택 (Author's Choice)

> **이 기법을 사용하지 않기로 결정한 이유**

저자 (YK)는 다음 이유로 **시스템 프롬프트 슬리밍을 적극 사용하지 않습니다**:

### 장점 vs 단점 분석

| 측면 | 평가 |
|------|------|
| **토큰 절감** | ✓ 7,300 토큰 절감 (41% 감소) |
| **비용 절감** | ✓ 월간 API 비용 약간 감소 |
| **구현 난이도** | ✗ 매우 높음 |
| **유지보수** | ✗ Claude 업데이트 시 재적용 필요 |
| **위험도** | ✗ 예상치 못한 부작용 가능성 |
| **ROI** | ✗ 개발 비용 >> 절감액 |

### 결론

```
9% 토큰 절감 < 100시간 개발/테스트/유지보수 비용
```

**개발 시간 최적화가 토큰 절감보다 훨씬 중요합니다.**

---

## 대체 최적화 방법 (Recommended Alternatives)

대신 다음 기법들을 **강력히 권장**합니다:

### 1. Prompt Compression

```
시스템 프롬프트 수정 | 프롬프트 축약
개발 비용: 매우 높음 | 개발 비용: 낮음
위험도: 높음 | 위험도: 낮음
효과: 41% | 효과: 10-20%
```

**더 나은 선택입니다.**

### 2. Context Windowing

필요한 정보만 포함시키기:

```python
# 나쁜 예
context = entire_codebase  # 모든 코드 포함

# 좋은 예
context = relevant_files_only  # 필요한 파일만
```

### 3. Batch Processing

여러 작업을 한 번에:

```python
# 비효율적
for item in items:
    response = claude.call(f"Process {item}")  # 18k 오버헤드 x N

# 효율적
response = claude.call(f"Process all: {items}")  # 18k 오버헤드 x 1
```

### 4. Smart Caching

```
요청 1: "Analyze this code" → 18k + 실제 프롬프트
요청 2: "Analyze that code" → 캐시된 18k + 새로운 프롬프트만
```

---

## 결정 기준 (Decision Matrix)

**언제 System Prompt Slimming을 고려할 것인가?**

```
┌─────────────────────────────────────────┐
│ 월간 API 비용이 $10,000을 넘는가?      │
│ AND                                     │
│ 9% 토큰 절감 = 월간 $900+ 절감?       │
│ AND                                     │
│ 개발/테스트 비용을 감당할 수 있는가?   │
│ AND                                     │
│ 지속적인 유지보수가 가능한가?          │
└─────────────────────────────────────────┘

모든 답이 "YES" → 고려 가능
하나라도 "NO" → 다른 최적화 방법 선택
```

---

## 주의사항 (Warnings)

### 1. Claude 업데이트 위험

```
상황: Claude 모델이 업데이트됨
문제: 시스템 프롬프트도 변경됨
결과: 패치가 작동하지 않거나 오류 발생
해결: 모든 테스트를 다시 실행하고 패치 재적용
```

### 2. 성능 저하

```
제거: "Tool X는 Y를 할 수 있습니다"
결과: Claude가 Tool X를 사용하지 않음
영향: 기능 손실, 오류율 증가
```

### 3. 보안 이슈

```
실수로 제거: 보안 관련 지시사항
결과: Claude가 위험한 작업 수행
심각도: 매우 높음
```

### 4. 테스트의 어려움

```
문제: 의도치 않은 부작용을 발견하기 어려움
예: 특정 경우에만 오류 발생
결과: 프로덕션에서 예상치 못한 문제
```

---

## 성공 사례 분석 (When It Works Well)

다음 경우에는 효과가 있을 수 있습니다:

### 1. 매우 특화된 작업

```
예: "코드 분석 전용 시스템"
제거 가능: 문서 작성, 데이터 처리 등 관련 없는 설명
```

### 2. 내부 시스템

```
예: 기업 내부 AI 어시스턴트
장점: 문제 발생 시 즉시 대응 가능
```

### 3. 완전 자동화

```
예: 자동화된 코드 분석 파이프라인
테스트: 매우 광범위한 자동 테스트 가능
```

---

## 참고 자료 (Resources)

### 추천 읽을거리

1. **[YK's System Prompt Patches](https://github.com/yk-dang/system-prompt-patches)** - 구체적인 패치 예제
2. **[Anthropic Documentation](https://docs.anthropic.com/)** - 공식 문서
3. **[Advanced Context Management](../01-context-memory/)** - 더 안전한 최적화 기법

### 관련 섹션

- [Token 측정 및 모니터링](./01-measuring-tokens.md)
- [Prompt Compression](./02-prompt-compression.md)
- [Context Windowing](./03-context-windowing.md)
- [Batch Processing](./04-batch-processing.md)
- [Smart Caching](./05-smart-caching.md)

---

## 결론 (Conclusion)

### 핵심 요점

1. **System Prompt Slimming은 가능하지만 위험합니다**
   - 토큰 절감: 41% (약 7,300 토큰)
   - 개발 비용: 매우 높음
   - 유지보수: 지속적 필요

2. **ROI가 맞지 않는 경우가 대부분입니다**
   - 토큰 절감 < 개발 시간 비용
   - 다른 최적화가 더 효율적

3. **더 안전한 대안들이 많습니다**
   - Prompt Compression
   - Context Windowing
   - Batch Processing
   - Smart Caching

### 권장사항

```
대부분의 사용자: 시스템 프롬프트 수정 X
                → 다른 최적화 기법 선택

고급 사용자 (대규모 시스템):
                → 신중하게 평가하고 철저하게 테스트
```

---

## 자주 묻는 질문 (FAQ)

**Q: 정말 41% 토큰을 절감할 수 있나요?**

A: 이론상으로는 가능하지만, 실제로는:
- 패치 적용 후 기능 손실 가능성
- 새로운 구조 설명이 필요할 수 있음
- 실제 절감: 20-30% 정도가 현실적

**Q: Claude 업데이트 시 어떻게 되나요?**

A: 시스템 프롬프트도 함께 업데이트되므로:
- 모든 패치를 다시 적용해야 함
- 호환성 문제 발생 가능
- 지속적인 유지보수 필요

**Q: 저도 시도해볼 수 있나요?**

A: 가능하지만:
- 매우 신중하게 접근
- 철저한 테스트 필수
- 프로덕션 전에 충분한 검증
- YK's patches를 참고하여 시작

**Q: 다른 최적화와 함께 사용 가능한가요?**

A: 기술적으로는 가능하지만:
- 복잡도 증가
- 예상치 못한 상호작용
- 테스트 난이도 대폭 증가

---

<div align="center">

### 기억하세요

**가장 좋은 최적화는 "안 하는" 것입니다.**

불필요한 복잡도를 추가하기 전에, 더 간단한 해결책을 먼저 시도하세요.

</div>

---

**작성자**: YK (개인 선택: 시스템 프롬프트 수정 미사용)
**마지막 수정**: 2026년 1월
**상태**: 완성

# Wrap V3 설계 논의 (2026-01-22)

## 현재 문제

```
wrap v2 실행 결과 (단순 파일 1개 수정 시):
┌───────────────┬───────────┬───────┬──────────┐
│   에이전트    │ Tool 사용 │ 토큰  │   시간   │
├───────────────┼───────────┼───────┼──────────┤
│ wrap-reader   │ 9회       │ 22.9k │ 30초     │
│ wrap-analyzer │ 17회      │ 27.9k │ 1분 14초 │
│ wrap-reporter │ 8회       │ 24.5k │ 44초     │
└───────────────┴───────────┴───────┴──────────┘
총합: ~75k 토큰, 약 2분 30초
```

**근본 원인**: "다 갖고 와 → 다 분석해" 방식
- wrap-reader가 모든 diff, 모든 rules, 모든 docs 경로를 수집
- 변경과 무관한 것까지 수집/분석하여 토큰 낭비

---

## Wrap의 원래 목적

| 목적 | 설명 |
|------|------|
| **세션 기록** | 내가 뭘 했는지 컨텍스트 파일로 저장 |
| **품질 체크** | 규칙 위반, 놓친 거 없는지 검증 |
| **다음 세션 준비** | TODO/맥락 정리해서 연속성 확보 |
| **액션 제안** | 분석 결과로 할 일 추천 |

### 분석 기능 (사용자 선택)
- 규칙 준수 체크 (.claude/rules 기반)
- 문서 동기화 (코드 변경 → 문서 업데이트 필요?)
- 리팩토링 기회 탐지
- 연관 파일 확인 (import/test 등)

---

## 개선 방향: Goal-first 구조

### 현재 (Data-first)
```
wrap-reader    → "다 갖고 와"
     ↓
wrap-analyzer  → "다 분석해"
     ↓
wrap-reporter  → "다 정리해"
```

### 제안 (Goal-first)
```
메인 Claude
├── git diff 확인
├── 목적/스코프 결정
│   "commands/foo.md 변경 → 규칙체크만 필요"
│
└── 목적별 에이전트 병렬 실행
    ├── 규칙 체크 에이전트 → (수집+분석+결과) 한번에
    ├── 문서 동기화 에이전트 → (수집+분석+결과) 한번에
    └── 리팩토링 에이전트 → (수집+분석+결과) 한번에

결과 통합 → 브리핑 + 컨텍스트 저장
```

**핵심 변화**:
- 먼저 diff 보고, 뭐가 필요한지 판단하고, 그것만 가져옴
- 각 에이전트가 수집+분석+결과를 한번에 처리
- 분석하면서 바로 결과 도출 (분리 X)

---

## 시나리오별 예상

### 시나리오 1: 단순 (파일 1개)
```
변경: commands/feedback.md

메인 Claude:
├── diff 확인 → "커맨드 파일 1개"
├── 판단 → "규칙 체크만"
└── 규칙 체크 에이전트 실행

예상: ~5k 토큰, 15초
```

### 시나리오 2: 중간 (코드+테스트)
```
변경: src/api/user.ts, tests/user.test.ts

병렬 실행:
├── 규칙 체크 에이전트
├── 리팩토링 에이전트
└── 연관 파일 에이전트

예상: ~15k 토큰, 40초
```

### 시나리오 3: 복잡 (대규모)
```
변경: 10개 파일

병렬 실행: 전체 에이전트

예상: ~25k 토큰, 1분
```

---

## 추가 논의: 코드맵 아이디어

파일 간 관계(의존성 그래프)를 미리 가지고 있으면:
- diff만 보고 관련 파일 즉시 파악 가능
- 더 정확한 선택적 수집 가능

**비판적 관점**:
- 코드맵 생성/유지보수 비용
- Outdated 위험
- 언어/프레임워크별 차이

**대안**:
- Just-in-time 탐색 (매번 필요한 것만 파싱)
- 휴리스틱 기반 (경로 패턴으로 추측)
- 하이브리드 (코드맵 있으면 사용, 없으면 탐색)

→ 이 부분은 wrap v3 범위 밖일 수 있음 (별도 결정 필요)

---

## 결정 필요 사항

### Wrap v3 범위

| 범위 | 목적 유지 | 구조 변경 | 추가 인프라 |
|------|----------|----------|------------|
| **A: 최적화만** | ✅ 전부 유지 | ❌ 현재 구조 | ❌ 없음 |
| **B: Goal-first** | ✅ 전부 유지 | ✅ diff 기반 선택적 수집 | ❌ 없음 |
| **C: B + 코드맵** | ✅ 전부 유지 | ✅ diff 기반 | ✅ 코드맵/의존성 그래프 |

**권장**: B (Goal-first 구조 변경)

---

## 결정사항 (2026-01-22)

### 범위: B (Goal-first 구조)

### 핵심 원칙
1. **메인은 판단만** - `git diff --stat`으로 파일 목록만 보고 스코프 결정
2. **상세 수집은 에이전트가** - 스코프 힌트 받고 필요한 것만 읽고 분석
3. **메인 컨텍스트 최소화** - 상세 내용은 에이전트 컨텍스트에서 처리

### 에이전트 구조 (v1 재활용)
| 에이전트 | 역할 | 수정 필요 |
|----------|------|----------|
| pattern-checker | 규칙 준수 체크 | Input 방식 변경 |
| doc-sync-checker | 문서 동기화 체크 | Input 방식 변경 |
| context-builder | 세션 기록 저장 | Input 방식 변경 |

### 삭제 대상 (v2 에이전트)
- wrap-reader
- wrap-analyzer
- wrap-reporter

### 메인 Claude 판단 흐름
```
1. git diff --stat 확인 (파일 목록만)
2. 변경 파일 특성 분석
   - 코드 파일? → pattern-checker 필요
   - API 변경? → doc-sync-checker 필요
   - 문서만? → 둘 다 스킵 가능
3. 스코프 힌트 생성
   - "commands 관련 규칙만"
   - "API 문서만 확인"
4. 필요한 에이전트만 병렬 호출
5. 결과 통합
6. context-builder 호출 (항상, 마지막에)
```

### 에이전트 Input 방식 변경
```yaml
# Before (v1/v2)
Input Required:
  - diff_data: From diff-reader agent
  - rules_data: From rules-reader agent

# After (v3)
Input:
  - changed_files: 메인이 전달 (파일 목록)
  - scope_hint: 메인이 전달 ("commands 관련만")
  - 에이전트가 직접 상세 내용 수집+분석
```

---

## 구현 작업

1. [x] 범위 최종 결정 (B)
2. [x] 에이전트 구조 상세 설계
3. [x] 메인 Claude의 "판단" 로직 정의
4. [ ] commands/wrap-v3.md 작성
5. [ ] agents/pattern-checker.md 수정
6. [ ] agents/doc-sync-checker.md 수정
7. [ ] agents/context-builder.md 수정

---

## 명령어

이 파일을 읽고 이어서 작업:
```
이 파일 읽어줘: .claude/context/wrap-v3-planning.md
```

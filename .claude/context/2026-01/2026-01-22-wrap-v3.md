# Session: 2026-01-22 11:00

## 맥락
wrap 시스템의 메인 에이전트 토큰 낭비 문제 해결을 위해 v3 아키텍처 설계 및 구현. 기존 v2에서 불필요한 에이전트 14개를 제거하고 코어 3개로 축소하는 리팩토링 진행.

## 작업 요약
- wrap v2 문제 분석: 토큰 낭비 (~75k) 원인 파악 (diff 없이 전체 컨텍스트 수집)
- Goal-first 구조 설계: 메인은 `git diff --stat`만 분석 후 필요시 에이전트 위임
- commands/wrap.md 재작성 (v3 스타일로 전환)
- commands/wrap-v2.md 삭제
- 불필요 에이전트 14개 삭제 (diff-reader, commit-drafter, pattern-checker-low 등)
- 코어 에이전트 3개 입력 방식 변경: 스코프 힌트 기반 수집으로 전환
- git status에서 확인: 3개 파일 수정, 15개 파일 삭제

## 문제 → 해결
- 메인 에이전트가 모든 파일 내용을 수집하여 토큰 초과 → git diff --stat만 먼저 보고 필요한 부분만 수집하도록 구조 변경
- 에이전트가 너무 많아서 선택 복잡도 증가 → 패턴, 문서 동기화, 컨텍스트 생성 3가지 핵심만 유지
- 각 에이전트의 입력 방식 불명확 → 스코프 힌트 (which files/patterns) 기반으로 명확히 정의

## 결정사항
- 메인 에이전트는 `git diff --stat`만 분석: diff 통해 어떤 파일이 변경되었는지만 파악하고, 세부 컨텍스트는 에이전트가 직접 수집
- 에이전트 축소: pattern-checker, doc-sync-checker, context-builder 3개만 유지
- 에스컬레이션: -high 버전 유지로 복잡한 상황에서 상위 모델로 위임 가능하도록 보존
- 결정 근거: 토큰 효율성 극대화 + 유지보수 복잡도 감소 + 필요시 확장 가능한 구조 유지

## 미완료/TODO
- [ ] wrap v3 실제 동작 테스트 (세션 실행 후 검증)
- [ ] 에이전트 -high 버전들 구현 확인 및 최신화 필요시 수정
- [ ] wrap v3 사용 가이드 문서화 (README 또는 별도 가이드)

## 다음 세션 제안
- wrap v3로 실제 세션 실행하여 동작 검증 (토큰 사용량, 에이전트 위임 동작 확인)
- 필요시 프롬프트 미세조정 (에이전트 스코프 힌트 형식 개선)
- 다른 에이전트도 v3 스타일로 점진적 마이그레이션 고려
